<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamentos - Painel Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="{{ url_for('index') }}" class="logo">
                <span class="logo-icon">💈</span>
                Barbearia Elite
            </a>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="nav-link">🏠 Início</a>
     
        <div class="nav-links">
            <a href="{{ url_for('gerenciar_servicos') }}" class="nav-link admin-btn">
                🛠️ Gerenciar Serviços
            </a>
        </div>
    </div>
</nav>
            </div>
        </div>
    </nav>

    <main class="appointments-container">
        <h1 class="appointments-title">📅 Painel de Agendamentos</h1>

        <!-- View Principal (Calendário + Lista) -->
        <div id="mainView" class="view active">
            <!-- Calendário -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav" id="prevMonth">❮</button>
                    <div class="month-year" id="monthYear"></div>
                    <button class="calendar-nav" id="nextMonth">❯</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Cabeçalhos dos dias da semana -->
                    <div class="weekday-header">Dom</div>
                    <div class="weekday-header">Seg</div>
                    <div class="weekday-header">Ter</div>
                    <div class="weekday-header">Qua</div>
                    <div class="weekday-header">Qui</div>
                    <div class="weekday-header">Sex</div>
                    <div class="weekday-header">Sáb</div>
                </div>
            </div>

            <!-- Lista completa de agendamentos -->
            <div class="all-appointments">
                <h2 style="padding: 1.5rem; margin: 0; background: #333; color: white; font-size: 1.3rem;">
                    📋 Todos os Agendamentos
                </h2>
               <div id="allAppointmentsList">
    {% for data, ags in agendamentos_por_data.items() %}
        <div class="date-section" data-date="{{ data }}">
            <div class="date-header">
                📌 {{ data }} ({{ ags|length }} cliente{{ 's' if ags|length != 1 else '' }})
            </div>
            <table class="appointments-table">
                <thead>
                    <tr>
                        <th>🕐 Horário</th>
                        <th>👤 Nome</th>
                        <th>💇 Serviço</th>
                        <th>📱 Telefone</th>
                        <th>📞 Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ag in ags %}
                    <tr>
                        <td><strong>{{ ag.hora }}</strong></td>
                        <td>{{ ag.nome }}</td>
                        <td>{{ ag.servico }}</td>
                        <td>{{ ag.telefone }}</td>
                        <td>
                            <a href="https://wa.me/55{{ ag.telefone|replace('(', '')|replace(')', '')|replace('-', '')|replace(' ', '') }}?text=Olá {{ ag.nome }}! Confirmando seu agendamento para {{ ag.data }} às {{ ag.hora }} - {{ ag.servico }}" 
                               target="_blank"
                               class="whatsapp-btn">
                               📲 WhatsApp
                            </a>
                            <form action="{{ url_for('remover_agendamento') }}" method="post" style="display:inline;">
                                <input type="hidden" name="agendamento_id" value="{{ ag.id }}">
                                <button type="submit" class="remove-btn" onclick="return confirm('Tem certeza que deseja remover este agendamento?');">
                                    🗑️ Remover
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endfor %}
    {% if not agendamentos_por_data %}
        <div class="empty-state">
            <div class="empty-icon">🔍</div>
            <h3>Nenhum agendamento encontrado</h3>
            <p>Quando os clientes fizerem agendamentos, eles aparecerão aqui.</p>
        </div>
    {% endif %}
</div>
            </div>
        </div>

        <!-- View do Dia Específico -->
        <div id="dayView" class="view">
            <div class="day-view-container">
                <div class="day-header">
                    <div class="day-title" id="dayTitle">📅 Agendamentos do Dia</div>
                    <button class="back-btn" id="backToMain">
                        ← Voltar para Visão Completa
                    </button>
                </div>
                <div id="dayAppointments" class="day-appointments">
                    <!-- Conteúdo será preenchido pelo JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <script>
        console.log('=== DEBUG: Script carregado ===');
        
        // Dados dos agendamentos do Flask
        let agendamentosData = {};
        try {
            agendamentosData = {{ agendamentos_json|safe }};
            console.log('✅ Dados recebidos do Flask:', agendamentosData);
        } catch(e) {
            console.error('❌ Erro ao carregar dados:', e);
            // Dados de exemplo para teste
            agendamentosData = {
                "20/01/2025": [
                    {
                        "id": 1,
                        "nome": "João Silva",
                        "telefone": "(11) 99999-9999",
                        "servico": "Corte + Barba",
                        "hora": "14:00",
                        "data": "20/01/2025"
                    }
                ]
            };
            console.log('🔧 Usando dados de exemplo:', agendamentosData);
        }
        
        // Variáveis globais
        let currentDate = new Date();
        let selectedDate = null;

        // Nomes dos meses
        const meses = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        // Função para formatar data no padrão brasileiro
        function formatDateBR(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Função para gerar o calendário
        function generateCalendar(date) {
            console.log('🗓️ Gerando calendário para:', date);
            
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // Atualizar cabeçalho
            document.getElementById('monthYear').textContent = `${meses[month]} ${year}`;
            
            // Limpar grid (manter cabeçalhos)
            const grid = document.getElementById('calendarGrid');
            const headers = grid.querySelectorAll('.weekday-header');
            grid.innerHTML = '';
            headers.forEach(header => grid.appendChild(header));
            
            // Primeiro dia do mês
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Gerar 42 dias (6 semanas)
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = cellDate.getDate();
                
                const dateStr = formatDateBR(cellDate);
                
                // Verificar se é do mês atual
                if (cellDate.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                } else {
                    // Verificar se tem agendamentos
                    if (agendamentosData[dateStr] && agendamentosData[dateStr].length > 0) {
                        dayElement.classList.add('has-appointments');
                        dayElement.title = `${agendamentosData[dateStr].length} agendamento(s)`;
                        console.log('📌 Dia com agendamentos:', dateStr, agendamentosData[dateStr]);
                    }
                    
                    // Adicionar evento de clique
                    dayElement.addEventListener('click', function() {
                        console.log('🖱️ Clicou no dia:', dateStr);
                        showDayView(dateStr, cellDate);
                    });
                    
                    // Adicionar cursor pointer
                    dayElement.style.cursor = 'pointer';
                }
                
                grid.appendChild(dayElement);
            }
            
            console.log('✅ Calendário gerado com sucesso');
        }

        // Função para mostrar a view do dia específico
        function showDayView(dateStr, dateObj) {
            console.log('🔍 Mostrando view do dia:', dateStr);
            
            selectedDate = dateStr;
            
            // Esconder view principal e mostrar view do dia
            const mainView = document.getElementById('mainView');
            const dayView = document.getElementById('dayView');
            
            mainView.classList.remove('active');
            dayView.classList.add('active');
            console.log('👁️ Views alternadas');
            
            // Atualizar título
            const dayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const dayName = dayNames[dateObj.getDay()];
            document.getElementById('dayTitle').textContent = `📅 ${dayName}, ${dateStr}`;
            
            // Buscar agendamentos do dia
            const appointments = agendamentosData[dateStr] || [];
            console.log('📋 Agendamentos encontrados:', appointments);
            
            const container = document.getElementById('dayAppointments');
            
            if (appointments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📭</div>
                        <h3>Nenhum agendamento para este dia</h3>
                        <p>Este dia está livre para novos agendamentos.</p>
                    </div>
                `;
                console.log('📭 Nenhum agendamento encontrado para', dateStr);
            } else {
                container.innerHTML = `
                    <div class="day-summary">
                        <h3>📊 Resumo do Dia</h3>
                        <p><strong>${appointments.length}</strong> cliente${appointments.length !== 1 ? 's' : ''} agendado${appointments.length !== 1 ? 's' : ''}</p>
                    </div>
                    <table class="appointments-table">
                        <thead>
                            <tr>
                                <th>🕐 Horário</th>
                                <th>👤 Nome</th>
                                <th>💇 Serviço</th>
                                <th>📱 Telefone</th>
                                <th>📞 Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appointments.map(ag => `
                                <tr>
                                    <td><strong>${ag.hora}</strong></td>
                                    <td>${ag.nome}</td>
                                    <td>${ag.servico}</td>
                                    <td>${ag.telefone}</td>
                                    <td>
                                        <a href="https://wa.me/55${ag.telefone.replace(/\D/g, '')}?text=Olá ${ag.nome}! Confirmando seu agendamento para ${ag.data} às ${ag.hora} - ${ag.servico}" 
                                           target="_blank"
                                           class="whatsapp-btn">
                                            📲 WhatsApp
                                        </a>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                console.log('✅ Tabela de agendamentos criada');
            }
        }

        // Função para voltar à view principal
        function showMainView() {
            console.log('🔙 Voltando para view principal');
            
            const dayView = document.getElementById('dayView');
            const mainView = document.getElementById('mainView');
            
            dayView.classList.remove('active');
            mainView.classList.add('active');
            selectedDate = null;
            
            console.log('✅ Voltou para view principal');
        }

        // Event listeners
        document.getElementById('prevMonth').addEventListener('click', function() {
            console.log('⬅️ Mês anterior');
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar(currentDate);
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            console.log('➡️ Próximo mês');
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar(currentDate);
        });

        document.getElementById('backToMain').addEventListener('click', function() {
            console.log('🔙 Botão voltar clicado');
            showMainView();
        });

        // Inicialização quando a página carrega
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM carregado, inicializando...');
            
            // Verificar se os elementos existem
            const mainView = document.getElementById('mainView');
            const dayView = document.getElementById('dayView');
            const calendarGrid = document.getElementById('calendarGrid');
            
            console.log('Elements check:', {
                mainView: !!mainView,
                dayView: !!dayView,
                calendarGrid: !!calendarGrid
            });
            
            // Inicializar calendário
            generateCalendar(currentDate);
            
            console.log('✅ Inicialização concluída');
        });

        // Teste manual - você pode executar no console do navegador
        window.testShowDay = function() {
            console.log('🧪 TESTE MANUAL');
            showDayView('20/01/2025', new Date(2025, 0, 20));
        };
        
        console.log('💡 Para testar manualmente, digite no console: testShowDay()');
    </script>
</body>
</html>